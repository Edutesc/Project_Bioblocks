scripts:
  - name: Install Unity
    script: | 
      echo "Installing Unity ${UNITY_VERSION}"
      brew install --cask unity-hub
      /Applications/Unity\ Hub.app/Contents/MacOS/Unity\ Hub -- --headless install --version ${UNITY_VERSION} --changeset c1a37c6a3757 --module ios
      
  - name: Set Unity path
    script: |
      export UNITY_PATH="/Applications/Unity/Hub/Editor/${UNITY_VERSION}/Unity.app/Contents/MacOS/Unity"
      echo "Unity path: $UNITY_PATH"
      
  - name: Activate Unity License
    script: | 
      /Applications/Unity/Hub/Editor/${UNITY_VERSION}/Unity.app/Contents/MacOS/Unity \
        -batchmode \
        -quit \
        -logFile \
        -serial ${UNITY_SERIAL} \
        -username ${UNITY_EMAIL} \
        -password ${UNITY_PASSWORD}
  
  - name: Set build number
    script: | 
      export NEW_BUILD_NUMBER=$(($(app-store-connect get-latest-testflight-build-number "$APP_STORE_ID") + 1))
  
  - name: Build Unity iOS project
    script: | 
      /Applications/Unity/Hub/Editor/${UNITY_VERSION}/Unity.app/Contents/MacOS/Unity \
        -batchmode \
        -quit \
        -logFile \
        -projectPath . \
        -executeMethod BuildIos.Build \
        -buildTarget iOS
  
  - name: Build iOS
    script: | 
      xcode-project build-ipa \
        --workspace "ios/${APP_NAME}.xcworkspace" \
        --scheme ${APP_NAME}